import{j as e,F as p,r as o,I as K,S as V,D as ee,U as pe,B as se,R as ue,a as me,C as le,O as xe,f as fe,c as he,V as te,s as ge,u as ye,b as je,d as be,e as we,g as Ne,h as ne,N as ke,i as f,k as Ce,l as Se,T as ve,m as Ie,n as oe,o as re,p as Te,P as Ae,q as Fe,t as N,L as ie,v as Le,w as Pe,x as ze,M as ce,A as Re,y as Ee,z as Oe}from"./index-CSbSx99W.js";const De=({color:k="currentColor",size:C="1em",...u})=>e.jsx("svg",{stroke:k,fill:k,strokeWidth:"0",viewBox:"0 0 512 512",height:C,width:C,xmlns:"http://www.w3.org/2000/svg",...u,children:e.jsx("path",{fill:"none",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"32",d:"m304 48 112 112-112 112m94.87-112H96m112 304L96 352l112-112m-94 112h302"})}),{TextArea:Me}=K,Ue=({onClose:k,text:C,tags:u,title:A,knowledgeContentId:h,token:j,existingMentions:q=[]})=>{const[y]=p.useForm(),[m,W]=o.useState([]),[F,S]=o.useState(!1),[D,Y]=o.useState(""),L=p.useWatch("mentions",y)??[],_=(q||[]).map(t=>({value:t.userId,label:t.fullName,display:t.fullName})),[M,g]=o.useState([]),[G,B]=o.useState(!1),[$,J]=o.useState(""),P=p.useWatch("people",y)??[],[z,H]=o.useState([]),b=p.useWatch("units",y)??[],Q=t=>{const c=((t.email||"").trim().split("@")[0]||"").toLowerCase(),i=(t.userName||"").toLowerCase();return c.startsWith("sso")||i.startsWith("sso")},R=async t=>{try{const n=await ge(t);return(Array.isArray(n)?n:[]).filter(c=>!Q(c))}catch(n){return console.error("Search error:",n),[]}},E=async t=>{if(!t)return W([]);S(!0);const n=await R(t),c=new Set(L.map(i=>i.value));W(n.map(i=>({value:i.id,label:i.fullName,display:`${i.fullName} — ${i.email??""}`,disabled:c.has(i.id)}))),S(!1)},v=async t=>{if(!t)return g([]);B(!0);const n=await R(t),c=new Set(P.map(i=>i.value));g(n.map(i=>({value:i.id,label:i.fullName,display:`${i.fullName} — ${i.email??""}`,disabled:c.has(i.id)}))),B(!1)};o.useEffect(()=>{(async()=>{try{const n=await fe();n!=null&&n.data&&Array.isArray(n.data)&&H(n.data)}catch(n){console.error("خطا در دریافت واحدها:",n)}})()},[]);const I=(u||[]).map(t=>t.tagTitle),ae=async t=>{var n,c;try{const i=(t.mentions||[]).map(d=>Number(d.value)).filter(d=>!isNaN(d)),w=(t.file||[]).map(d=>(d==null?void 0:d.originFileObj)??d).filter(Boolean),U=(t.people||[]).map(d=>Number(d.value)).filter(d=>!isNaN(d)),O=(t.units||[]).map(d=>Number(d.value)).filter(d=>!isNaN(d)),X={KnowledgeContentId:h,Title:t.title,Abstract:t.abstract??"",Text:t.text,Tags:t.tags||[],MentionUserId:i,References:t.reference?[t.reference]:[],KnowledgeContentAttachments:w,Users:U,Units:O};await he(X,j),window.dispatchEvent(new CustomEvent("knowledge:updated",{detail:{id:h}})),te.success("✅ محتوا با موفقیت تبدیل شد"),k()}catch(i){const w=(c=(n=i==null?void 0:i.response)==null?void 0:n.data)==null?void 0:c.modelErrors;if(w!=null&&w.length){const U=w.map(O=>O.modelErrorMessage).join(`
`);te.error(U,{style:{whiteSpace:"pre-line",border:"1px solid red",padding:8,color:"#b00020",fontWeight:"bold"},icon:"⚠️"})}else te.error("⚠️ خطای غیرمنتظره رخ داد");console.error(i)}};return e.jsxs(e.Fragment,{children:[e.jsxs(p,{form:y,layout:"vertical",className:"mt-2 font-yekan csstom-form",initialValues:{title:A,abstract:"",tags:I,reference:"",text:C,mentions:_,file:[],people:[],units:[]},onFinish:ae,style:{direction:"rtl",font:"BYekan"},children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"text-[17px] text-[#333333] font-bold",children:"تبدیل به ساختار یافته"}),e.jsx("div",{className:"mt-2 h-px bg-gray-300 w-full"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(p.Item,{label:"عنوان",name:"title",rules:[{required:!0,message:"عنوان الزامی است"}],children:e.jsx(K,{className:"custom-input",placeholder:"عنوان"})}),e.jsx(p.Item,{label:"چکیده",name:"abstract",rules:[{required:!0,message:"چکیده الزامی است"}],children:e.jsx(K,{className:"custom-input",placeholder:"چکیده"})}),e.jsx(p.Item,{label:"تگ‌ها",name:"tags",rules:[{required:!0,message:"حداقل یک تگ انتخاب کنید"}],children:e.jsx(V,{mode:"multiple",allowClear:!0,className:"custom-input",placeholder:"تگ‌ها",children:u.map((t,n)=>e.jsx(V.Option,{value:t.tagTitle,children:t.tagTitle},n))})}),e.jsx(p.Item,{label:"مرجع (Reference)",name:"reference",children:e.jsx(K,{className:"custom-input",placeholder:"مرجع",style:{height:34}})})]}),e.jsx(p.Item,{label:"متن",name:"text",rules:[{required:!0,message:"لطفا متن را وارد کنید"}],children:e.jsx(Me,{rows:4,className:"customtextarea custom-input",placeholder:"متن"})}),e.jsx(p.Item,{label:"ارجاع (Mention)",name:"mentions",children:e.jsx(V,{mode:"multiple",labelInValue:!0,showSearch:!0,searchValue:D,onSearch:t=>{Y(t),E(t)},autoClearSearchValue:!1,filterOption:!1,options:m,optionLabelProp:"label",optionRender:t=>e.jsx("div",{className:"font-yekan",children:t.data.display??t.data.label}),allowClear:!0,placeholder:"نام افراد را وارد کنید",notFoundContent:F?"در حال جستجو...":"نتیجه‌ای یافت نشد",tagRender:()=>null,maxTagCount:0,maxTagPlaceholder:null,className:"font-yekan custom-input mention-select",style:{height:34,background:"#fff"}})}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:L.map(({value:t,label:n})=>e.jsxs("span",{className:"flex items-center gap-2 bg-gray-100 text-sm rounded px-2 py-[4px] border border-gray-300",children:[n,e.jsx("button",{type:"button",style:{color:"#ff4d4f"},onClick:()=>y.setFieldValue("mentions",L.filter(c=>c.value!==t)),title:"حذف",children:e.jsx(ee,{})})]},t))}),e.jsx(p.Item,{label:null,className:"upload-item",colon:!1,children:e.jsxs("div",{className:"upload-box",children:[e.jsx("span",{className:"upload-label",children:"افزودن فایل"}),e.jsx(p.Item,{name:"file",valuePropName:"fileList",getValueFromEvent:t=>(t==null?void 0:t.fileList)||[],noStyle:!0,children:e.jsx(pe,{beforeUpload:()=>!1,showUploadList:!0,listType:"text",multiple:!0,className:"upload-trigger",children:e.jsx(se,{icon:e.jsx(ue,{}),className:"upload-btn",children:"انتخاب فایل"})})})]})}),e.jsxs("div",{className:"flex flex-col gap-3 font-yekan bg-gray-100 rounded-xl font-semibold p-3",children:[e.jsx("label",{className:"font-yekan",children:"تعیین دسترسی"}),e.jsxs(me,{gutter:16,children:[e.jsxs(le,{span:12,children:[e.jsx(p.Item,{className:"font-yekan",label:"واحد سازمانی",name:"units",children:e.jsx(V,{mode:"multiple",className:"font-yekan custom-input",labelInValue:!0,showSearch:!0,allowClear:!0,placeholder:"انتخاب کنید",optionFilterProp:"label",options:z.map(t=>({value:t.id,label:t.departmentTitle})),tagRender:()=>null,maxTagCount:0,maxTagPlaceholder:null})}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:b.map(({value:t,label:n})=>e.jsxs("span",{className:"flex items-center gap-2 bg-gray-100 text-sm rounded px-2 py-[4px] border border-gray-300",children:[n,e.jsx("button",{type:"button",style:{color:"#ff4d4f"},onClick:()=>y.setFieldValue("units",b.filter(c=>c.value!==t)),title:"حذف",children:e.jsx(ee,{})})]},t))})]}),e.jsxs(le,{span:12,children:[e.jsx(p.Item,{className:"font-yekan",label:"افراد",name:"people",children:e.jsx(V,{className:"font-yekan custom-input",mode:"multiple",labelInValue:!0,showSearch:!0,searchValue:$,onSearch:t=>{J(t),v(t)},autoClearSearchValue:!1,filterOption:!1,options:M,optionLabelProp:"label",optionRender:t=>e.jsx("div",{className:"font-yekan",children:t.data.display??t.data.label}),allowClear:!0,placeholder:"نام افراد را وارد کنید",notFoundContent:G?"در حال جستجو...":"نتیجه‌ای یافت نشد",tagRender:()=>null,maxTagCount:0,maxTagPlaceholder:null})}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:P.map(({value:t,label:n})=>e.jsxs("span",{className:"flex items-center gap-2 bg-gray-100 text-sm rounded px-2 py-[4px] border border-gray-300",children:[n,e.jsx("button",{type:"button",style:{color:"#ff4d4f"},onClick:()=>y.setFieldValue("people",P.filter(c=>c.value!==t)),title:"حذف",children:e.jsx(ee,{})})]},t))})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-4 mt-6",children:[e.jsx(se,{className:"w-[172.82px] rounded-xl no-blue-border",onClick:k,type:"default",children:"بازگشت"}),e.jsx(se,{className:"w-[172.82px] bg-[#007041] rounded-xl bg-green-custom",type:"primary",htmlType:"submit",children:"تبدیل به ساختار یافته"})]})]}),e.jsx(xe,{position:"bottom-right"})]})},{Paragraph:de,Text:x,Title:Ve}=ve,Be=()=>{const[k,C]=o.useState(!1),[u,A]=o.useState(null),[h,j]=o.useState(1),[q,y]=o.useState(!0),[m,W]=o.useState(6),[F,S]=o.useState(null),[,D]=o.useState(0),[Y,L]=o.useState(!1),[_,M]=o.useState(1),[g,G]=o.useState(void 0),B=ye(),$=je.useRef(null),J=s=>{A(s),L(!0)},P=()=>{L(!1),A(null)},z=be(s=>s.search.results),[H,b]=o.useState([]),Q=we(),R=JSON.parse(localStorage.getItem("user")||"{}"),E=R==null?void 0:R.id,v=localStorage.getItem("sessionId"),I=v!=null&&v.startsWith("Bearer ")?v:`Bearer ${v}`,t=new URLSearchParams(B.search).get("searchText")||"",n=o.useCallback(async(s=1,l=9,a)=>{try{y(!0);const r=await Ne("",s,l,a),T=(r==null?void 0:r.data)||[],Z=(r==null?void 0:r.pagingInfo)||null;b(T),Z?(M(Z.pageCount),D(Z.allEntitiesCount)):(M(1),D(0))}catch(r){console.error("Error fetching data:",r),b([]),M(1),D(0)}finally{y(!1)}},[]);o.useEffect(()=>{t.trim()===""&&(n(1,m,g),j(1))},[t,n,m,g]),o.useEffect(()=>{const s=l=>{var T;const r=(T=l.detail)==null?void 0:T.goalId;G(r),j(1)};return window.addEventListener("knowledge:filter-by-goal",s),()=>window.removeEventListener("knowledge:filter-by-goal",s)},[]),o.useEffect(()=>{const s=l=>{var T;(T=l.detail)!=null&&T.id&&n(h,m,g)};return window.addEventListener("knowledge:updated",s),()=>window.removeEventListener("knowledge:updated",s)},[n,h,m,g]),o.useEffect(()=>{const s=()=>{j(1),n(1,m,g)};return window.addEventListener("knowledge:created",s),()=>window.removeEventListener("knowledge:created",s)},[n,m,g]),o.useEffect(()=>{window.scrollTo({top:0,behavior:"smooth"})},[h]),o.useEffect(()=>{n(h,m,g)},[h,m,g,n]),o.useEffect(()=>{z&&z.length>0&&(b(z),j(1))},[z]);const c=async s=>{if(!E||!I){alert("ابتدا وارد حساب کاربری خود شوید");return}S(s);try{(await Oe(s,E,I)).success&&b(a=>a.map(r=>r.id===s?{...r,isLiked:!0,likeCount:(r.likeCount||0)+1}:r))}catch(l){console.error("Error in like:",l)}finally{S(null)}},i=async s=>{if(!E||!I){alert("ابتدا وارد حساب کاربری خود شوید");return}S(s);try{(await Ee(s,E,I)).success&&b(a=>a.map(r=>r.id===s?{...r,isLiked:!1,likeCount:Math.max((r.likeCount||1)-1,0)}:r))}catch(l){console.error("Error in unlike:",l)}finally{S(null)}},w=s=>{A(s),C(!0)},U=()=>{C(!1),A(null)};o.useLayoutEffect(()=>{window.scrollTo({top:0})},[h]);const O=(s,l)=>{var a;l&&l!==m?(W(l),j(1)):j(s),(a=$.current)==null||a.scrollIntoView({behavior:"smooth"})};if(q)return e.jsx("div",{className:"flex justify-center items-center",style:{height:"100vh"},children:e.jsx(ne,{})});if(H.length===0)return e.jsx(ke,{});const X=(s,l,a)=>l==="page"?e.jsx("a",{style:{margin:"0 4px",padding:"0 8px",height:"32px",lineHeight:"32px",minWidth:"32px",borderRadius:"4px",display:"inline-block",textAlign:"center",color:"#000"},children:N(s)}):l==="prev"?e.jsx("a",{className:"font-yekan",style:{margin:"0 4px",padding:"0 8px",height:"32px",lineHeight:"32px",minWidth:"32px",borderRadius:"4px",display:"inline-block",textAlign:"center",border:"1px solid #d9d9d9"},children:"قبلی"}):l==="next"?e.jsx("a",{className:"font-yekan",style:{margin:"0 4px",padding:"0 8px",height:"32px",lineHeight:"32px",minWidth:"32px",borderRadius:"4px",display:"inline-block",textAlign:"center",border:"1px solid #d9d9d9"},children:"بعدی"}):l==="jump-prev"||l==="jump-next"?e.jsx("span",{style:{margin:"0 4px"},children:"..."}):a,d=H;return e.jsxs("div",{ref:$,style:{display:"flex",flexDirection:"column",gap:16,marginTop:"1rem"},children:[e.jsx(f,{direction:"vertical",size:15,style:{width:"100%",borderRadius:8},children:d.map(s=>{var l;return e.jsxs(Ce,{className:"border-[1px] cursor-pointer hover:border-green-600 w-full md:max-w-none max-w-[95%]",onClick:()=>w(s),style:{width:"100%",fontFamily:"BYekan"},bodyStyle:{padding:6,height:"100%",display:"flex",flexDirection:"column",justifyContent:"space-between",fontFamily:"BYekan"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsxs(f,{children:[e.jsx(Se,{size:12.24,color:"#000000A6"}),e.jsx(x,{className:"font-yekan",style:{fontSize:12.25,color:"#000000A6",fontWeight:600},children:s.user.fullName})]}),e.jsx("p",{className:"text-[#000000A6] text-[14px]",style:{margin:0},children:Ie(s.createdDate)})]}),e.jsx(Ve,{className:"font-yekan",level:5,style:{color:"#007041"},children:s.title}),e.jsxs("div",{className:`${s.abstract?"mb-[0.2rem]":""}`,style:{display:"flex",justifyContent:"space-between"},children:[e.jsxs(f,{children:[e.jsx(x,{className:"font-yekan",style:{fontSize:13,color:"#000000A6"},children:"دسته بندی:"}),e.jsx(x,{className:"font-yekan",style:{fontSize:13,color:"#000000A6"},children:s.goalTitle})]}),s.knowledgeContentType==="Structured"?e.jsxs(f,{className:"flex items-center gap-1",children:[e.jsx(oe,{size:10.49,color:"#000000A6"}),e.jsx(x,{className:"font-yekan",style:{fontSize:11,color:"#000000A6"},children:"ساختار یافته"})]}):s.knowledgeContentType==="Official"?e.jsxs(f,{className:"flex items-center gap-1",children:[e.jsx(re,{size:10.49,color:"#000000A6"}),e.jsx(x,{className:"font-yekan",style:{fontSize:11,color:"#000000A6"},children:"درس آموخته"})]}):s.knowledgeContentType==="NonStructured"?e.jsxs(f,{className:"flex items-center gap-1",children:[e.jsx(oe,{size:10.49,color:"#000000A6"}),e.jsx(x,{className:"font-yekan",style:{fontSize:11,color:"#000000A6"},children:"غیر ساختاریافته"})]}):null]}),s.abstract&&e.jsxs("div",{className:"flex flex-col gap-1",style:{background:"#F7F7F8",borderRadius:8,display:"flex",padding:"1rem"},children:[e.jsx(x,{className:"font-yekan",style:{fontSize:12.25,color:"#333"},children:"چکیده:"}),e.jsx(de,{style:{fontSize:12.25,color:"#333"},children:s.abstract})]}),e.jsx("div",{className:"mb-[2rem] mt-[2rem]",children:e.jsx(de,{className:"font-yekan font-semibold",ellipsis:{rows:3,expandable:!1},style:{fontSize:14,width:"80%",color:"#333",marginBottom:0,lineHeight:"2em",maxHeight:"7.8em",overflow:"hidden",textOverflow:"ellipsis",display:"flex",WebkitLineClamp:3,WebkitBoxOrient:"vertical"},children:s.text})}),s.attachments.map(a=>a!=null&&a.address?e.jsxs("a",{href:`${Te}${a.address}`,download:a.name,target:"_blank",rel:"noreferrer",onClick:r=>r.stopPropagation(),className:"flex items-center justify-between gap-10 w-fit mt-4 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-xl",style:{direction:"ltr"},children:[e.jsx("div",{className:"flex items-center gap-1 text-[1rem]",children:e.jsx("span",{className:"block overflow-clip",children:a.name||"دانلود فایل پیوست"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-[1rem] font-medium",children:"فایل پیوست"}),e.jsx(re,{size:22})]})]},a.id):null),s.mentions&&s.mentions.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-4",children:s.mentions.map((a,r)=>e.jsxs("div",{className:"flex items-center gap-1 bg-gray-100 px-2 py-[2px] rounded-lg border border-gray-300",children:[e.jsx("p",{className:"text-[12px] text-[#007041] font-bold",children:"@"}),e.jsx("p",{className:"text-[12px] text-[#333] font-semibold",children:a.fullName})]},a.userId??r))}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(x,{className:"font-yekan",style:{fontSize:10.5,color:"#333",marginTop:8},children:e.jsx("div",{className:"flex items-center gap-1",children:s.tags.map((a,r)=>e.jsxs("div",{className:"flex items-center text-[11px] text-[#333333]",children:[e.jsx("p",{className:"text-[15px]",children:"#"}),e.jsx("p",{className:"flex",children:a.tagTitle})]},r))})}),e.jsxs(f,{children:[((l=s.knowledgeContentType)==null?void 0:l.trim().toLowerCase())==="nonstructured"?e.jsxs(f,{className:"bg-[#fbfbfb] hover:bg-gray-200",onClick:a=>{a.stopPropagation(),J(s)},style:{padding:"4px 8px",borderRadius:8,cursor:"pointer"},children:[e.jsx(De,{size:12.24,color:"#000000A6"}),e.jsx(x,{className:"font-yekan",style:{fontSize:13,color:"#000000A6"},children:"تبدیل"})]}):e.jsxs(f,{onClick:a=>{a.stopPropagation(),Q(`/knowledgeContentPrint/${s.id}`)},style:{background:"#F0F0F0",padding:"4px 8px",borderRadius:8,cursor:"pointer"},children:[e.jsx(Ae,{size:12.24,color:"#000000A6"}),e.jsx(x,{className:"font-yekan",style:{fontSize:13,color:"#000000A6"},children:"پرینت"})]}),e.jsxs(f,{className:"font-yekan",style:{background:"#F0F0F0",padding:"4px 8px",borderRadius:8},children:[e.jsx(Fe,{size:12.24,color:"#000000A6"}),e.jsx(x,{className:"font-yekan",style:{fontSize:13,color:"#000000A6"},children:s.commentCount?N(s.commentCount):N("0")})]}),s.isLiked?e.jsxs(f,{onClick:a=>{a.stopPropagation(),i(s.id)},className:`
                      bg-[#00693D] 
                      hover:bg-[#00693D] 
                      p-1 
                      rounded-lg 
                      text-white 
                      ${F===s.id?"opacity-50 bg-[#00693D]":"hover:bg-[#00693D]"}`,children:[F===s.id?e.jsx(ne,{size:"small"}):e.jsx(ie,{size:12.24,color:"#ffff"}),e.jsx(x,{className:"font-yekan text-white",children:N(s.likeCount?s.likeCount:"0")})]}):e.jsxs(f,{onClick:a=>{a.stopPropagation(),c(s.id)},className:`bg-[#F0F0F0] p-1 rounded-lg  cursor-pointer transition group ${F===s.id?"opacity-50":"hover:bg-[#00693D]"}`,children:[F===s.id?e.jsx(ne,{size:"small"}):e.jsx(ie,{size:12.24,color:"#000000A6",className:"group-hover:fill-white"}),e.jsx(x,{className:"font-yekan text-[#000000A6] group-hover:text-white",children:N(s.likeCount?s.likeCount:"0")})]})]})]})]},s.id)})}),e.jsx("div",{className:"bg-white font-yekan p-4 rounded-xl flex",style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:24,direction:"rtl",width:"100%"},children:e.jsx(Le,{direction:"rtl",locale:Pe,children:e.jsx(ze,{className:"w-full ant-pagination flex font-yekan justify-end",current:h,total:_*m,pageSize:m,onChange:O,showSizeChanger:!0,onShowSizeChange:(s,l)=>O(1,l),pageSizeOptions:["6","12","24","50"],showTotal:(s,l)=>e.jsx("span",{className:"font-yekan ant-pagination text-center",style:{marginLeft:"8px",fontFamily:"BYekan"},children:`صفحه ${N(l[0])}-${N(l[1])} از ${N(s)}`}),itemRender:X,style:{fontFamily:"BYekan",display:"flex",alignItems:"center"},locale:{items_per_page:"/ صفحه"}})})}),e.jsx(ce,{open:k,onCancel:U,footer:null,closable:!0,centered:!0,width:"auto",bodyStyle:{padding:0,background:"transparent",boxShadow:"none",display:"flex",justifyContent:"center",alignItems:"center"},style:{background:"transparent",boxShadow:"none"},maskStyle:{backgroundColor:"rgba(0, 0, 0, 0.4)"},children:u&&e.jsx(Re,{item:u,showActions:!1})}),e.jsx(ce,{open:Y,onCancel:P,footer:null,width:768,centered:!0,destroyOnClose:!0,children:u&&e.jsx(Ue,{onClose:P,text:u.text,tags:u.tags,title:u.title,knowledgeContentId:u.id,token:I||"",existingMentions:(u.mentions||[]).map(s=>({userId:s.userId,fullName:s.fullName}))})})]})};export{Be as default};
